# MOSS 综合联动系统测试说明

## 测试目标

验证MOSS智能教育模块的**多硬件协同工作能力**，这是一个完整的系统集成测试，包含：
- 声音检测与状态切换
- LED灯光效果联动
- 舵机转向控制
- OLED状态显示
- 多模块并行运行

**测试级别**: 系统集成测试（第六阶段）

## 测试文件

- `test/test_integrated_system.cpp.bak` - 综合联动测试程序（I2S数字麦克风版本）

## 硬件要求

### 必需硬件清单：

| 模块 | 型号/规格 | 引脚配置 | 数量 |
|------|----------|---------|------|
| 主控芯片 | ESP32-S3 | - | 1 |
| OLED显示屏 | SSD1306 (128x64) | GPIO1/2 (I2C) | 1 |
| LED灯环（摄像头） | WS2812_4020 | GPIO48（串联） | 2颗 |
| LED灯环（身体） | WS2812B-2020 | GPIO48（串联） | 3颗 |
| 水平舵机 | 标准舵机 | GPIO4 | 1 |
| 垂直舵机 | 标准舵机 | GPIO5 | 1 |
| 麦克风 | SPH0645 (I2S) | GPIO7/12/13 | 2 |
| 喇叭模块 | MAX98357A (I2S) | GPIO9/10/11 | 1 |

### 完整引脚连接表：

#### OLED显示屏（I2C）
| OLED引脚 | ESP32-S3引脚 | 说明 |
|---------|-------------|------|
| VCC | 3.3V | 电源 |
| GND | GND | 地线 |
| SDA | GPIO 2 | I2C数据线 |
| SCL | GPIO 1 | I2C时钟线 |

#### LED灯环（WS2812B串联）
| LED | ESP32-S3引脚 | 说明 |
|-----|-------------|------|
| 所有LED（5个） | GPIO 48 | 数据线（串联） |
| VCC | 5V | 电源 |
| GND | GND | 地线 |

**LED索引分配**:
- 索引0-1: 摄像头LED（瞳孔）
- 索引2-4: 机身LED（状态灯环）

#### 舵机
| 舵机 | ESP32-S3引脚 | 说明 |
|------|-------------|------|
| 水平舵机 | GPIO 4 | PWM控制 |
| 垂直舵机 | GPIO 5 | PWM控制 |
| VCC | 5V | 电源（独立供电） |
| GND | GND | 地线 |

#### I2S麦克风（SPH0645）
| 麦克风引脚 | ESP32-S3引脚 | 说明 |
|-----------|-------------|------|
| BCLK | GPIO 13 | 串行时钟（共用） |
| LRCL (WS) | GPIO 7 | 字选择（共用） |
| DOUT | GPIO 12 | 数据线（共用） |
| 左麦克风 SEL | GND | 左声道 |
| 右麦克风 SEL | 3.3V | 右声道 |
| 3V | 3.3V | 电源 |
| GND | GND | 地线 |

#### 喇叭模块（MAX98357A）
| 喇叭引脚 | ESP32-S3引脚 | 说明 |
|---------|-------------|------|
| LRC | GPIO 9 | 左右时钟 |
| BCLK | GPIO 10 | 位时钟 |
| DIN | GPIO 11 | 数据输入 |
| VIN | 5V | 电源 |
| GND | GND | 地线 |

---

## 系统架构

### 状态机设计

```
┌─────────────┐
│ STATE_IDLE  │ 待机状态
│ (蓝色呼吸)  │
└──────┬──────┘
       │ 检测到声音
       ↓
┌─────────────┐
│STATE_LISTEN │ 监听状态
│ (绿色常亮)  │
└──────┬──────┘
       │ 音量>阈值
       ↓
┌─────────────┐
│STATE_ACTIVE │ 活跃状态
│ (橙色高亮)  │ ← 舵机转向声源
└──────┬──────┘
       │ 3秒无声音
       ↓
┌─────────────┐
│STATE_SPEAK  │ 说话状态
│ (紫色闪烁)  │
└──────┬──────┘
       │ 完成
       ↓
    返回待机
```

### 模块联动逻辑

```
声音检测 → LED变色 → 舵机转向 → OLED更新
  (10ms)    (20ms)     (500ms)      (50ms)
```

---

## 测试内容

### 1. 待机模式（STATE_IDLE）

**触发条件**: 系统启动或长时间无声音

**硬件表现**:
- **机身LED**: 蓝色呼吸灯效果（索引2-4）
- **瞳孔LED**: 暗红色（索引0-1）
- **舵机**: 微动（模拟呼吸）
- **OLED**: 显示"IDLE"状态
- **麦克风**: 持续监听

**验证点**:
- ✅ LED呼吸效果流畅
- ✅ 舵机微动自然
- ✅ OLED显示正确
- ✅ 麦克风实时检测

---

### 2. 监听模式（STATE_LISTENING）

**触发条件**: 检测到声音（音量 > 50）

**硬件表现**:
- **机身LED**: 绿色常亮
- **瞳孔LED**: 暗红色
- **舵机**: 停止微动
- **OLED**: 显示"LISTENING"和音量条
- **麦克风**: 实时显示音量

**验证点**:
- ✅ LED颜色切换及时
- ✅ 音量条实时更新
- ✅ 舵机停止微动
- ✅ 状态切换流畅

---

### 3. 活跃模式（STATE_ACTIVE）

**触发条件**: 音量峰值 > 100（固定阈值）

**硬件表现**:
- **机身LED**: 橙色高亮
- **瞳孔LED**: 亮红色（聚焦）
- **舵机**: 转向声源方向
- **OLED**: 显示"ACTIVE!"和音量峰值
- **声源定位**: 计算左右声道时间差

**验证点**:
- ✅ LED立即变为橙色
- ✅ 舵机转向准确（基于TDOA）
- ✅ OLED显示音量峰值
- ✅ 瞳孔LED变亮红色

**声源定位算法**:
```cpp
// 基于TDOA（时间差）计算方位角
时间差 = (左声道峰值时间 - 右声道峰值时间)
距离差 = 时间差 × 声速
角度 = arcsin(距离差 / 麦克风间距)
```

---

### 4. 说话模式（STATE_SPEAKING）

**触发条件**: 手动触发或API响应

**硬件表现**:
- **机身LED**: 紫色闪烁
- **瞳孔LED**: 亮红色
- **舵机**: 保持当前位置
- **OLED**: 显示"SPEAKING"
- **喇叭**: 播放TTS音频

**验证点**:
- ✅ LED紫色闪烁
- ✅ 音频播放正常
- ✅ 舵机保持稳定

---

## 串口命令

测试程序支持以下串口命令：

| 命令 | 功能 | 说明 |
|------|------|------|
| `a` | 模拟声音触发 | 切换到活跃状态 |
| `l` | 模拟左侧声源 | 舵机转向60度 |
| `r` | 模拟右侧声源 | 舵机转向120度 |
| `i` | 返回待机 | 切换到待机状态 |
| `s` | 说话模式 | 切换到说话状态 |

---

## 运行测试

### 准备工作：

1. **硬件连接**:
   - 按照引脚连接表连接所有硬件
   - 确认舵机独立供电（5V，至少1A）
   - 确认LED电源充足

2. **软件准备**:
   - 确认所有依赖库已安装
   - 备份当前main.cpp

### 运行步骤：

```cmd
# 1. 重命名文件（去掉.bak后缀）
ren test\test_integrated_system.cpp.bak test_integrated_system.cpp

# 2. 临时替换main.cpp
ren src\main.cpp main.cpp.bak
copy test\test_integrated_system.cpp src\main.cpp

# 3. 编译上传
pio run -t upload

# 4. 打开串口监控
pio device monitor

# 5. 测试完成后恢复
del src\main.cpp
ren src\main.cpp.bak main.cpp
```

### 预期输出（串口）：

```
=================================
   MOSS 综合联动测试
=================================

初始化中...
[✓] OLED显示屏初始化成功
[✓] LED灯环初始化成功
[✓] 舵机初始化成功
[✓] I2S麦克风初始化成功
[✓] 喇叭初始化成功

系统就绪！

状态: IDLE
音量: 0
峰值: 0

--- 检测到声音 ---
状态: LISTENING
音量: 65

--- 音量峰值触发 ---
状态: ACTIVE
峰值: 125
转向: 75度

--- 3秒无声音 ---
状态: IDLE
```

---

## 性能指标

根据测试报告（第六阶段测试）：

| 指标项 | 目标值 | 实测值 | 状态 |
|--------|--------|--------|------|
| 主循环频率 | ≥100Hz | ~100Hz | ✅ |
| 声音检测延迟 | <100ms | ~50ms | ✅ |
| 舵机响应延迟 | <100ms | ~80ms | ✅ |
| LED刷新率 | ≥30fps | ~50fps | ✅ |
| 显示屏刷新 | ≥10fps | ~20fps | ✅ |
| 状态切换延迟 | <200ms | ~150ms | ✅ |

---

## 测试场景

### 场景1：声音触发测试

**步骤**:
1. 系统启动，进入待机状态（蓝色呼吸）
2. 拍手或说话
3. 观察LED变绿（监听）
4. 大声拍手
5. 观察LED变橙色，舵机转向

**预期结果**:
- ✅ 状态切换流畅
- ✅ LED颜色正确
- ✅ 舵机转向及时

### 场景2：声源定位测试

**步骤**:
1. 在左侧拍手
2. 观察舵机是否转向左侧（<90度）
3. 在右侧拍手
4. 观察舵机是否转向右侧（>90度）

**预期结果**:
- ✅ 舵机转向与声源位置一致
- ✅ 转向角度合理（30-150度）

### 场景3：串口命令测试

**步骤**:
1. 发送命令 `a` - 模拟声音触发
2. 发送命令 `l` - 模拟左侧声源
3. 发送命令 `r` - 模拟右侧声源
4. 发送命令 `i` - 返回待机

**预期结果**:
- ✅ 所有命令响应正常
- ✅ 状态切换正确
- ✅ 舵机转向准确

### 场景4：长时间稳定性测试

**步骤**:
1. 让系统连续运行2小时
2. 定期触发声音
3. 观察是否有异常

**预期结果**:
- ✅ 无内存泄漏
- ✅ 无状态卡死
- ✅ 响应始终及时

---

## 技术细节

### I2S麦克风配置（SPH0645）

```cpp
i2s_config_t i2s_config = {
    .mode = (i2s_mode_t)(I2S_MODE_MASTER | I2S_MODE_RX),
    .sample_rate = 16000,
    .bits_per_sample = I2S_BITS_PER_SAMPLE_32BIT,
    .channel_format = I2S_CHANNEL_FMT_RIGHT_LEFT,
    .communication_format = I2S_COMM_FORMAT_STAND_MSB,  // MSB左对齐
    .intr_alloc_flags = ESP_INTR_FLAG_LEVEL1,
    .dma_buf_count = 4,
    .dma_buf_len = 512,
    .use_apll = false,
    .tx_desc_auto_clear = false,
    .fixed_mclk = 0
};
```

**关键配置**:
- **格式**: MSB左对齐（SPH0645专用）
- **采样率**: 16kHz
- **位深度**: 32位（实际18位有效）
- **声道**: 立体声（左右麦克风）

### 声源定位算法

```cpp
// 1. 找到左右声道的峰值位置
int leftPeakIndex = findPeakIndex(leftChannel);
int rightPeakIndex = findPeakIndex(rightChannel);

// 2. 计算时间差（样本数）
int timeDiff = leftPeakIndex - rightPeakIndex;

// 3. 转换为距离差
float distanceDiff = (timeDiff / SAMPLE_RATE) * SOUND_SPEED;

// 4. 计算角度
float angle = asin(distanceDiff / MIC_DISTANCE) * 180 / PI;

// 5. 转换为舵机角度（90度为中心）
int servoAngle = 90 + angle;
```

### LED颜色定义

```cpp
// 机身LED（索引2-4）
COLOR_BOOT      = RGB(128, 0, 128)   // 紫色（启动）
COLOR_IDLE      = RGB(0, 50, 100)    // 蓝色（待机）
COLOR_LISTENING = RGB(0, 255, 0)     // 绿色（监听）
COLOR_ACTIVE    = RGB(255, 100, 0)   // 橙色（活跃）
COLOR_SPEAKING  = RGB(255, 0, 255)   // 紫色（说话）

// 瞳孔LED（索引0-1）
COLOR_EYE_OFF   = RGB(0, 0, 0)       // 关闭
COLOR_EYE_DIM   = RGB(50, 0, 0)      // 暗红（待机）
COLOR_EYE_FOCUS = RGB(255, 0, 0)     // 亮红（聚焦）
```

---

## 故障排查

### 问题1：麦克风无声音
**可能原因**:
- I2S配置错误
- 麦克风SEL引脚未配置
- 接线错误

**解决方法**:
1. 确认使用MSB左对齐格式
2. 确认左麦克风SEL接GND，右麦克风SEL接3.3V
3. 检查GPIO7/12/13连接

### 问题2：舵机不转向
**可能原因**:
- 舵机电源不足
- PWM信号异常
- 角度计算错误

**解决方法**:
1. 使用独立5V电源供电（至少1A）
2. 检查GPIO4/5连接
3. 使用串口命令`l`/`r`测试

### 问题3：LED不亮或颜色错误
**可能原因**:
- GPIO48连接错误
- LED串联顺序错误
- 电源不足

**解决方法**:
1. 确认GPIO48连接到第一个LED的DIN
2. 确认5个LED按顺序串联
3. 使用5V电源（至少500mA）

### 问题4：状态切换不正常
**可能原因**:
- 音量阈值设置不当
- 麦克风灵敏度问题
- 状态机逻辑错误

**解决方法**:
1. 调整TRIGGER_THRESHOLD值
2. 使用串口命令手动测试
3. 查看串口输出的音量值

---

## 测试结果

### 测试状态：✅ 已通过

根据测试报告（第六阶段测试）：

| 测试场景 | 状态 | 说明 |
|---------|------|------|
| 待机模式 | ✅ 通过 | LED呼吸、舵机微动正常 |
| 监听模式 | ✅ 通过 | 声音检测、LED变色正常 |
| 活跃模式 | ✅ 通过 | 声源定位、舵机转向正常 |
| 自动演示 | ✅ 通过 | 状态循环、切换流畅 |
| 稳定性测试 | ✅ 通过 | 2小时无故障 |

### 联动时序验证：
```
声音检测 → LED变色 → 舵机转向 → 显示屏更新
   (10ms)    (20ms)     (500ms)      (50ms)
```
✅ 所有模块响应延迟在可接受范围内

---

## 相关文档

- **测试报告**: `测试报告.md` - 第六阶段综合联动测试
- **引脚配置**: `include/pin_config.h` - 完整引脚定义
- **设计文档**: `.kiro/specs/moss-education-module/design.md` - 系统架构设计

---

## 依赖库

```ini
[env:esp32-s3-devkitc-1]
lib_deps = 
    olikraus/U8g2@^2.35.9           # OLED显示
    adafruit/Adafruit NeoPixel@^1.12.0  # LED控制
    madhephaestus/ESP32Servo@^3.0.5     # 舵机控制
```

---

## 备注

1. **麦克风版本**: 本程序适配SPH0645 I2S麦克风（MSB左对齐格式）
2. **测试完成**: 已在实际硬件上验证通过
3. **性能优化**: 主循环频率~100Hz，满足实时性要求
4. **扩展性**: 可作为完整系统的基础，添加云端API和状态机

---

**文档结束**
